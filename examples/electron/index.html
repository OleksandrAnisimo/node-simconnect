<html>
    <head>
		<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
    </head>

    <body>
        <div id="status"></div>

        <br><br>

        <table>
            <tr style='background: lightgray'>
                <th style='min-width: 150px'>Name</th>
                <th>Value</th>
            </tr>
            <tr>
                <td>Paused</td>
                <td id="td-paused"></td>
            </tr>
			<tr>
                <td>Parking brake</td>
                <td id="td-park"></td>
            </tr>
            <tr>
                <td>Latitude</td>
                <td id="td-lat"></td>
            </tr>
            <tr>
                <td>Longitude</td>
                <td id="td-lng"></td>
            </tr>
            <tr>
                <td>Pitch</td>
                <td id="td-pitch"></td>
            </tr>
            <tr>
                <td>Bank</td>
                <td id="td-bank"></td>
            </tr>
			<tr>
                <td>Aircraft title</td>
                <td id="td-ac-title"></td>
            </tr>
            <tr>
                <td>AIR-path</td>
                <td id="td-ac-path"></td>
            </tr>            
			<tr>
                <td>Commands</td>
                <td>
					<button id="pause-toggle-btn">Toggle pause</button>
					<button id="parkbrake-toggle-btn">Toggle parking brake</button>
				</td>
            </tr>
        </table>
    </body>

    <script>
        const simConnect = require('../../build/Release/node-simconnect');

		// Some constants from SimConnect.h /////
		const SIMCONNECT_OBJECT_ID_USER = 0;
		
		const SIMCONNECT_PERIOD_ONCE = 1;
		const SIMCONNECT_PERIOD_SIM_FRAME = 3;
		
		const SIMCONNECT_DATATYPE_FLOAT64 = 4;
		const SIMCONNECT_DATATYPE_STRINGV = 11;
		//////////////////////////////////////////
		
        $('#status').text("-- Waiting for simulator --");
	
		var parkBrakeOn = false;
		
        // Open connection
        simConnect.open("MyAppName", function(name) {
            $('#status').text("Connected to: \"" + name + "\"");

            // Subscribe to paused/unpaused event
            simConnect.subscribeToSystemEvent("Pause", (paused) => { 
                $('#td-paused').text(paused == 1); 
            });
			
			// Get the .air file name of the currently loaded aircraft
            simConnect.requestSystemState("AircraftLoaded", function(obj) {
                $('#td-ac-path').text(obj.string);
				
				// Get aircraft title
				simConnect.requestDataOnSimObject([["TITLE", null, SIMCONNECT_DATATYPE_STRINGV]], function(data) {
					$('#td-ac-title').text(data[0]);
				}, SIMCONNECT_OBJECT_ID_USER, SIMCONNECT_PERIOD_ONCE);
            });

			// Detect when a new aircraft is loaded
            simConnect.subscribeToSystemEvent("AircraftLoaded", (data) => { 
                $('#td-ac-path').text(data);
				
				// Get aircraft title
				simConnect.requestDataOnSimObject([["TITLE", null, SIMCONNECT_DATATYPE_STRINGV]], function(data) {
					$('#td-ac-title').text(data[0]);
				});
            });
			
			// Request some data to be sent on every sim-frame.
			var requests = [
				// Variable names are found here: https://msdn.microsoft.com/en-us/library/cc526981.aspx
				["PLANE LATITUDE", "degrees"],
				["PLANE LONGITUDE", "degrees"],
				["PLANE PITCH DEGREES", "degrees"], 
				["PLANE BANK DEGREES", "degrees"],
				["BRAKE PARKING POSITION", "bool"]
			];			
			simConnect.requestDataOnSimObject(requests, function(data) {
				$('#td-lat').text(data[0]);
				$('#td-lng').text(data[1]);
				$('#td-pitch').text(data[2]);
				$('#td-bank').text(data[3]);
				
				parkBrakeOn = data[4] == 1;
				$('#td-park').text(parkBrakeOn);
			}, SIMCONNECT_OBJECT_ID_USER, SIMCONNECT_PERIOD_SIM_FRAME);

			// Toggle pause when button clicked
			$('#pause-toggle-btn').click(function() {
				// Event name is from this table: https://msdn.microsoft.com/en-us/library/cc526980.aspx#KeyEvents
				simConnect.transmitClientEvent('PAUSE_TOGGLE');
			});
			
			// Set parking brake when button clicked
			$('#parkbrake-toggle-btn').click(function() {
				// Datum name and unit found here: https://msdn.microsoft.com/en-us/library/cc526981.aspx
				simConnect.setDataOnSimObject("BRAKE PARKING POSITION", "Position", parkBrakeOn ? 0 : 1);
			});
			
			
			
        }, function() {
            $('#status').text("SimConnect quit");
        }, function(exception) {
            $('#status').text("SimConnect exception: " + exception.name + " (" + exception.dwException + ", " + exception.dwSendID + ", " + exception.dwIndex + ", " + exception.cbData);
        });
        
    </script>
</html>